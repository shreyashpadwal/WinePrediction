# ☁️ Azure Deployment Guide

This guide covers deploying the Wine Quality Prediction project to Microsoft Azure using Azure Container Registry, App Service, and Static Web Apps.

## 📋 Prerequisites

### Required Tools
- **Azure CLI**: Command-line interface for Azure
- **Docker**: For building and managing containers
- **Git**: For version control
- **Azure Account**: Free tier available

### Installation

#### Azure CLI Installation

**Windows:**
```powershell
# Using PowerShell
Invoke-WebRequest -Uri https://aka.ms/installazurecliwindows -OutFile .\AzureCLI.msi
Start-Process msiexec.exe -Wait -ArgumentList '/I AzureCLI.msi /quiet'
```

**macOS:**
```bash
brew install azure-cli
```

**Linux:**
```bash
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```

#### Verify Installation
```bash
az --version
az login
```

## 🏗️ Architecture Overview

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Azure ACR     │    │  App Service    │    │ Static Web Apps │
│   (Container    │◄──►│   (Backend)     │    │   (Frontend)    │
│    Registry)    │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Docker        │    │   FastAPI       │    │   React SPA     │
│   Images        │    │   + ML Models   │    │   + Nginx       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 🚀 Quick Start

### 1. Initial Setup

```bash
# Clone the repository
git clone <your-repo-url>
cd wine-quality-prediction

# Make scripts executable
chmod +x azure/*.sh

# Run Azure setup
./azure/acr-setup.sh
```

### 2. Build and Push Images

```bash
# Build Docker images
make build

# Push to Azure Container Registry
./azure/push-to-acr.sh
```

### 3. Deploy Services

```bash
# Deploy backend
./azure/backend-appservice.sh

# Deploy frontend
./azure/frontend-static-webapp.sh
```

## 📁 Azure Configuration Files

### Environment Configuration

**azure/.env.azure** (generated by acr-setup.sh):
```bash
# Azure Container Registry Credentials
ACR_NAME=winequalityacr
ACR_LOGIN_SERVER=winequalityacr.azurecr.io
ACR_USERNAME=winequalityacr
ACR_PASSWORD=<generated-password>

# Azure Resource Configuration
AZURE_RESOURCE_GROUP=wine-quality-rg
AZURE_LOCATION=eastus
AZURE_SUBSCRIPTION_ID=<your-subscription-id>

# Application Configuration
APP_SERVICE_PLAN=wine-quality-plan
BACKEND_APP_NAME=wine-quality-backend
FRONTEND_APP_NAME=wine-quality-frontend
```

## 🔧 Step-by-Step Deployment

### Step 1: Azure Container Registry Setup

The ACR setup script creates all necessary Azure resources:

```bash
./azure/acr-setup.sh
```

**What it does:**
- Creates resource group: `wine-quality-rg`
- Creates Azure Container Registry: `winequalityacr`
- Creates App Service Plan: `wine-quality-plan`
- Generates credentials and saves to `azure/.env.azure`

**Expected output:**
```
🍷 Azure Container Registry Setup Complete!
==========================================

📋 Summary:
  Resource Group: wine-quality-rg
  Location: eastus
  ACR Name: winequalityacr
  ACR Login Server: winequalityacr.azurecr.io
  App Service Plan: wine-quality-plan
```

### Step 2: Build and Push Docker Images

```bash
./azure/push-to-acr.sh
```

**What it does:**
- Builds backend and frontend Docker images
- Tags images with ACR repository URLs
- Pushes images to Azure Container Registry
- Verifies successful push

**Expected output:**
```
🍷 Images Successfully Pushed to ACR!
=====================================

📋 Summary:
  ACR Name: winequalityacr
  ACR Login Server: winequalityacr.azurecr.io
  Backend Image: winequalityacr.azurecr.io/wine-backend:latest
  Frontend Image: winequalityacr.azurecr.io/wine-frontend:latest
```

### Step 3: Deploy Backend to App Service

```bash
./azure/backend-appservice.sh
```

**What it does:**
- Creates Web App for Containers
- Configures environment variables
- Sets up continuous deployment from ACR
- Enables Application Insights
- Configures health checks

### Step 4: Deploy Frontend to Static Web Apps

```bash
./azure/frontend-static-webapp.sh
```

**What it does:**
- Creates Azure Static Web App
- Links to GitHub repository
- Configures build settings
- Sets up custom domain
- Enables CDN

## 🔍 Verification

### Check Deployment Status

```bash
# Check resource group
az group show --name wine-quality-rg

# Check ACR
az acr show --name winequalityacr --resource-group wine-quality-rg

# Check App Service
az webapp show --name wine-quality-backend --resource-group wine-quality-rg

# Check Static Web App
az staticwebapp show --name wine-quality-frontend --resource-group wine-quality-rg
```

### Test Endpoints

```bash
# Backend health check
curl https://wine-quality-backend.azurewebsites.net/api/v1/prediction/health

# Frontend
curl https://wine-quality-frontend.azurestaticapps.net
```

## 📊 Monitoring and Logs

### Application Insights

The backend deployment automatically enables Application Insights for monitoring:

```bash
# View Application Insights
az monitor app-insights component show --app wine-quality-backend --resource-group wine-quality-rg
```

### View Logs

```bash
# Backend logs
az webapp log tail --name wine-quality-backend --resource-group wine-quality-rg

# Static Web App logs
az staticwebapp environment show --name wine-quality-frontend --resource-group wine-quality-rg
```

## 🔒 Security Configuration

### Environment Variables

Sensitive data is stored in Azure App Service configuration:

```bash
# Set environment variables
az webapp config appsettings set --name wine-quality-backend --resource-group wine-quality-rg --settings \
  GEMINI_API_KEY="your-api-key" \
  ENVIRONMENT="production" \
  LOG_LEVEL="INFO"
```

### SSL/TLS

Both services automatically get SSL certificates:
- App Service: Managed certificate
- Static Web Apps: Automatic SSL

### Custom Domains

```bash
# Add custom domain to App Service
az webapp config hostname add --webapp-name wine-quality-backend --resource-group wine-quality-rg --hostname api.yourdomain.com

# Add custom domain to Static Web App
az staticwebapp hostname set --name wine-quality-frontend --resource-group wine-quality-rg --hostname yourdomain.com
```

## 💰 Cost Optimization

### Free Tier Resources

- **Azure Container Registry**: 1GB storage free
- **App Service**: F1 tier (free) available
- **Static Web Apps**: Free tier available
- **Application Insights**: 5GB data free per month

### Estimated Monthly Costs

| Service | Tier | Monthly Cost |
|---------|------|--------------|
| App Service | B1 | $13.14 |
| Static Web Apps | Free | $0 |
| Container Registry | Basic | $5 |
| Application Insights | Pay-as-you-go | $2-5 |
| **Total** | | **$20-25** |

### Cost Optimization Tips

1. **Use Free Tier**: Start with free tier resources
2. **Set Budget Alerts**: Configure spending limits
3. **Monitor Usage**: Regular cost reviews
4. **Reserved Instances**: For predictable workloads
5. **Auto-scaling**: Scale down during low usage

## 🚨 Troubleshooting

### Common Issues

#### 1. Azure CLI Not Found
```bash
# Install Azure CLI
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```

#### 2. Docker Not Running
```bash
# Start Docker service
sudo systemctl start docker
```

#### 3. ACR Login Failed
```bash
# Re-login to ACR
az acr login --name winequalityacr
```

#### 4. Image Push Failed
```bash
# Check ACR credentials
az acr credential show --name winequalityacr
```

#### 5. App Service Deployment Failed
```bash
# Check App Service logs
az webapp log tail --name wine-quality-backend --resource-group wine-quality-rg
```

### Debug Commands

```bash
# Check Azure CLI version
az --version

# Check Docker version
docker --version

# Check ACR connectivity
az acr check-health --name winequalityacr

# Check App Service status
az webapp show --name wine-quality-backend --resource-group wine-quality-rg --query "state"

# Check Static Web App status
az staticwebapp show --name wine-quality-frontend --resource-group wine-quality-rg --query "buildProperties"
```

## 🔄 CI/CD Pipeline

### GitHub Actions Workflow

Create `.github/workflows/azure-deploy.yml`:

```yaml
name: Deploy to Azure

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Build and Push to ACR
      run: |
        az acr build --registry winequalityacr --image wine-backend:latest ./backend
        az acr build --registry winequalityacr --image wine-frontend:latest ./frontend
    
    - name: Deploy to App Service
      run: |
        az webapp config container set --name wine-quality-backend --resource-group wine-quality-rg --docker-custom-image-name winequalityacr.azurecr.io/wine-backend:latest
```

## 📚 Additional Resources

- [Azure Container Registry Documentation](https://docs.microsoft.com/en-us/azure/container-registry/)
- [Azure App Service Documentation](https://docs.microsoft.com/en-us/azure/app-service/)
- [Azure Static Web Apps Documentation](https://docs.microsoft.com/en-us/azure/static-web-apps/)
- [Azure CLI Reference](https://docs.microsoft.com/en-us/cli/azure/)

## 🆘 Support

For issues with Azure deployment:

1. Check the troubleshooting section above
2. Review Azure service logs
3. Verify resource configurations
4. Check Azure service health status
5. Create an issue with detailed error logs

## 🎯 Next Steps

After successful deployment:

1. **Set up monitoring**: Configure alerts and dashboards
2. **Implement CI/CD**: Automate deployments
3. **Add custom domain**: Configure DNS
4. **Set up backup**: Configure backup strategies
5. **Performance tuning**: Optimize for production load
